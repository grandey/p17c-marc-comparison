#+TITLE: p17c-marc-comparison
#+AUTHOR: Benjamin S. Grandey
#+OPTIONS: ^:nil

** Purpose
Configure and analyse [[http://www.cesm.ucar.edu/][CESM]] simulations in order to compare /MARC/ (the /Modal Two-Moment Mixing-State-Resolving Aerosol Model for Radiation and Climate/) and [[http://www.geosci-model-dev.net/5/709/2012/][MAM]].

** Experimental design

*** Comparison simulations
In order to compare MARC, MAM3, and MAM7, five prescribed-SST simulations will be performed:
| Casename         | Aerosol model | Aersosol (and precursor) emissions |
|------------------+---------------+------------------------------------|
| =p17c_marc_2000= | MARC          | year-2000                          |
| =p17c_marc_1850= | MARC          | year-1850                          |
| =p17c_mam3_2000= | MAM3          | year-2000                          |
| =p17c_mam3_1850= | MAM3          | year-1850                          |
| =p17c_mam7_2000= | MAM7          | year-2000                          |

The year-2000 emissions simulations will facilitate comparison of aerosol fields, and also cloud microphysical and macrophysical fields. The year-1850 simulations will facilitate calculation of radiative flux perturbations (RFPs).

The simulations will be configured as follows:
1. *CESM 1.2.2.1* will be used. (This is CESM 1.2.2 configured to run on Cheyenne.)
2. MARC commit *ff48dbe* will be used.
3. Greenhouse gas concentrations and sea-surface temperatures (SSTs) will be prescribed using *year-2000 climatological values*, based on the =F_2000_CAM5= (=FC5=) component set.
4. For the MARC and MAM3 simulations, the *RFP components* will be diagnosed following [[http://www.atmos-chem-phys.net/13/9971/2013/][Ghan (2013)]]. The "online" radiation call will include aerosol-radiation interactions; the "offline" diagnostic radiation call will calculate "clean-sky" fluxes.
5. The *COSP* satellite simulator package will be activated.
6. A resolution of *f19_g16* will be specified.
7. Each simulation will be run for *32 years*, and the first two years will be excluded as spin-up. (Nudgding will not be performed.)
8. The simulations will be performed on *Cheyenne*, using 720 processors (20 nodes).

*** Timing simulations
In order to facilitate comparison of computational performance, several timing simulations will be performed:
| Casename         | Aerosol model | Radiation                 | Notes                         |
|------------------+---------------+---------------------------+-------------------------------|
| =p17c_t_marc_r2= | MARC          | Diagnostic clean-sky call | Standard MARC                 |
| =p17c_t_mam3_r2= | MAM3          | Diagnostic clean-sky call | =rad_diag_1= in =user_nl_cam= |
| =p17c_t_mam7_r2= | MAM7          | Diagnostic clean-sky call | =rad_diag_1= in =user_nl_cam= |
| =p17c_t_mam3_r1= | MAM3          | Single call               | Standard MAM3                 |
| =p17c_t_mam7_r1= | MAM7          | Single call               | Standard MAM7                 |

The simulations will be configured similarly to the comparison simulations described above, albeit with the following differences:
1. COSP will *not* be used.
2. "*20-day* model runs with *restarts and history turned off*" will be used, following the recommendations in the [[http://www.cesm.ucar.edu/models/cesm1.2/cesm/doc/usersguide/x1516.html][CESM User's Guide.]]
3. For each case, *five runs* will be performed in order to assess variability.
4. For consistency, all cases will be submitted *on the same day*.

** Data management

*** Saving a copy of the output data to Newton
Please see [[https://github.com/grandey/p17c-marc-comparison/blob/master/manage_data/archive_case_dir_p17c.sh][archive_case_dir_p17c.sh]], [[https://github.com/grandey/p17c-marc-comparison/blob/master/manage_data/gzip_netcdf_p17c.sh][gzip_netcdf_p17c.sh]], and [[https://github.com/grandey/p17c-marc-comparison/blob/master/manage_data/rsync_archive_to_newton.sh][rsync_archive_to_newton.sh]], which outline the workflow for the data from the comparison simulations.

*** Converting from time-slice to time-series format
After gunzipping a copy of the output history files on Newton, [[https://github.com/NCAR/PyReshaper][PyReshaper]] (v1.0.1) can be used to convert to time-series format. I have =PyReshaper= installed in a separate =conda= environment:

#+BEGIN_SRC
source activate pyreshaper
#+END_SRC

**** Converting atmospheric h0 data to time-series format

First, =s2make= is used to generate a specifier file, e.g. for atmosphere output:

#+BEGIN_SRC
CASENAME=p17c_marc_2000

IN_DIR=/somerset/grandey/data4/acrc/RUN/unzipped/$CASENAME/atm/hist
OUT_DIR=/dhobyghaut/grandey/data5/cesm/s2s/$CASENAME/atm

mkdir -p $OUT_DIR

s2smake \
    --netcdf_format="netcdf4" \
    --compression_level=1 \
    --output_prefix="$OUT_DIR/$CASENAME.cam.h0." \
    --output_suffix=".nc" \
    -m "time" -m "time_bnds" -m "ch4vmr" -m "co2vmr" -m "f11vmr" \
    -m "time_written" -m "n2ovmr" -m "date_written" -m "f12vmr" \
    -m "sol_tsi" -m "nsteph" -m "datesec" -m "ndcur" -m "date" \
    -m "nscur" \
    --specfile=$OUT_DIR/specfile_$CASENAME.s2s \
    $IN_DIR/$CASENAME.cam.h0.????-??.nc
#+END_SRC

(The metadata field information (indicated by =m=) has been copied from some example code Daniel Rothenberg kindly provided.)

Second, =s2run= is run in parallel in order to convert the data to time-series format:

#+BEGIN_SRC
mpirun -n 8 s2srun --verbosity=2 $OUT_DIR/specfile_$CASENAME.s2s
#+END_SRC

**** Converting land h0 data to time-series format

#+BEGIN_SRC
CASENAME_LIST="p17c_mam3_2000 p17c_mam3_1850 p17c_mam7_2000 p17c_marc_2000 p17c_marc_1850"
for CASENAME in $CASENAME_LIST
do
  IN_DIR=/somerset/grandey/data4/acrc/RUN/unzipped/$CASENAME/lnd/hist
  OUT_DIR=/dhobyghaut/grandey/data5/cesm/s2s/$CASENAME/lnd
  mkdir -p $OUT_DIR
  s2smake \
    --netcdf_format="netcdf4" \
    --compression_level=1 \
    --output_prefix="$OUT_DIR/$CASENAME.clm2.h0." \
    --output_suffix=".nc" \
    -m "time" -m "time_bounds" \
    -m "mcdate" -m "mcsec" -m "mdcur" -m "mscur" -m "nstep" \
    -m "date_written" -m "time_written" \
    --specfile=$OUT_DIR/specfile_$CASENAME.s2s \
    $IN_DIR/$CASENAME.clm2.h0.????-??.nc
  mpirun -n 8 s2srun --verbosity=2 $OUT_DIR/specfile_$CASENAME.s2s
done
#+END_SRC

**** Converting ice data to time-series format

#+BEGIN_SRC
CASENAME_LIST="p17c_mam3_2000 p17c_mam3_1850 p17c_mam7_2000 p17c_marc_2000 p17c_marc_1850"
for CASENAME in $CASENAME_LIST
do
  IN_DIR=/somerset/grandey/data4/acrc/RUN/unzipped/$CASENAME/ice/hist
  OUT_DIR=/dhobyghaut/grandey/data5/cesm/s2s/$CASENAME/ice
  mkdir -p $OUT_DIR
  s2smake \
    --netcdf_format="netcdf4" \
    --compression_level=1 \
    --output_prefix="$OUT_DIR/$CASENAME.cice.h." \
    --output_suffix=".nc" \
    -m "time" -m "time_bounds" \
    --specfile=$OUT_DIR/specfile_$CASENAME.s2s \
    $IN_DIR/$CASENAME.cice.h.????-??.nc
  mpirun -n 8 s2srun --verbosity=2 $OUT_DIR/specfile_$CASENAME.s2s
done
#+END_SRC

*** Syncing to local machine for analysis
Data of interest can then be pulled from Newton using rsync.

**** Syncing atmosphere output data
Note: some variable names differ between MARC and MAM3, and MAM7.

MARC fields of interest:

#+BEGIN_SRC
CASENAME_LIST="p17c_marc_2000 p17c_marc_1850"
VARIABLE_LIST=" \
FSNTOA FSNTOANOA FSNTOACNOA FSNS FSNSNOA SAF DRF CRF LWCF \
pSUL_LDG OC_LDG BC_LDG MOS_LDG MBS_LDG \
TAU_tot \
CCN3 TGCLDLWP TGCLDIWP TGCLDCWP CDNUMC \
CLDTOT CLDLOW CLDMED CLDHGH"
#+END_SRC

MAM fields of interest:

#+BEGIN_SRC
CASENAME_LIST="p17c_mam3_2000 p17c_mam3_1850 p17c_mam7_2000"
VARIABLE_LIST=" \
FSNTOA FSNTOA_d1 FSNTOAC_d1 FSNS FSNS_d1 SWCF_d1 LWCF LWCF_d1 \
BURDENSO4 BURDENPOM BURDENBC \
AEROD_v \
CCN3 TGCLDLWP TGCLDIWP TGCLDCWP CDNUMC \
CLDTOT CLDLOW CLDMED CLDHGH"
#+END_SRC

Rsync command:

#+BEGIN_SRC
for CASENAME in $CASENAME_LIST
do
  for VARIABLE in $VARIABLE_LIST
  do
    rsync -av --progress -e "ssh -p $NEWTON_PORT" \
        $NEWTON_USER@$NEWTON_IP:/dhobyghaut/grandey/data5/cesm/s2s/$CASENAME/atm/$CASENAME.cam.h0.$VARIABLE.nc \
        $HOME/data/projects/p17c_marc_comparison/output_timeseries/
  done
done
#+END_SRC

**** Syncing land output data

#+BEGIN_SRC
CASENAME_LIST="p17c_mam3_2000 p17c_mam3_1850 p17c_mam7_2000 p17c_marc_2000 p17c_marc_1850"
VARIABLE_LIST="FSNO SNOBCMSL"

for CASENAME in $CASENAME_LIST
do
  for VARIABLE in $VARIABLE_LIST
  do
    rsync -av --progress -e "ssh -p $NEWTON_PORT" \
        $NEWTON_USER@$NEWTON_IP:/dhobyghaut/grandey/data5/cesm/s2s/$CASENAME/lnd/$CASENAME.clm2.h0.$VARIABLE.nc \
        $HOME/data/projects/p17c_marc_comparison/output_timeseries/
  done
done
#+END_SRC

**** Syncing ice output data

#+BEGIN_SRC
CASENAME_LIST="p17c_mam3_2000 p17c_mam3_1850 p17c_mam7_2000 p17c_marc_2000 p17c_marc_1850"
VARIABLE_LIST="fs albsno albice"

for CASENAME in $CASENAME_LIST
do
  for VARIABLE in $VARIABLE_LIST
  do
    rsync -av --progress -e "ssh -p $NEWTON_PORT" \
        $NEWTON_USER@$NEWTON_IP:/dhobyghaut/grandey/data5/cesm/s2s/$CASENAME/ice/$CASENAME.cice.h.$VARIABLE.nc \
        $HOME/data/projects/p17c_marc_comparison/output_timeseries/
  done
done
#+END_SRC

** Status

*** Completed
***** DONE Design and check =user_nl_cam= files for comparison simulations
CLOSED: [2017-07-21 Fri 11:48]
***** DONE Reproduce MARC emissions files using scripts in =p17c_input_data/= and check input data
CLOSED: [2017-07-21 Fri 14:34]
***** DONE Design and check configuration (in =configure_comparison_simulations.org=) of comparison simulations
CLOSED: [2017-07-21 Fri 14:35]
***** DONE Create and submit comparison simulations
CLOSED: [2017-07-21 Fri 14:47]
***** DONE Store copy of output from comparison simulations on Newton
CLOSED: [2017-08-16 Wed 15:22]
***** DONE Convert atm h0 data from comparison simulations to time-series format on Newton
CLOSED: [2017-08-21 Mon 14:39]
***** DONE AMWG diagnostics for comparison simulations - Daniel done this
CLOSED: [2017-08-23 Wed 16:30]
***** DONE Preliminary analysis of RFPs for comparison simulations
CLOSED: [2017-08-24 Thu 12:39]
***** DONE Convert lnd h0 and cice h data from comparison simulations to time-series format on Newton
CLOSED: [2017-10-24 Tue 18:54]
***** DONE Design and finalize =user_nl_cam= files for timing simulations
CLOSED: [2017-10-25 Wed 14:03]
***** DONE Design and finalize configuration of timing simulations
CLOSED: [2017-10-25 Wed 14:03]

*** Still to-do
***** TODO Create and submit timing simulations
***** TODO Store copy of output from timing simulations on Newton
***** TODO Continue preliminary analysis of comparison simulations

** Author
Benjamin S. Grandey, 2017, in collaboration with [[http://www.danielrothenberg.com/][Daniel Rothenberg]], [[https://eapsweb.mit.edu/people/jqj][Qinjian Jin]], and [[http://web.mit.edu/wangc/][Chien Wang]].

** Acknowledgements
This repository has been developed in order to facilitate research conducted at the Singapore-MIT Alliance for Research and Technology (SMART), supported by the National Research Foundation (NRF), Prime Ministerâ€™s Office, Singapore under its Campus for Research Excellence and Technological Enterprise (CREATE) programme.
Thanks are due to Zheng Lu and Xiaohong Liu for advice about model configuration, especially MAM7.

